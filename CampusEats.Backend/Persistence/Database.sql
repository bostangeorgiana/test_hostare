DROP TABLE IF EXISTS
    students,
    users,
    menu_items,
    menu_labels,
    menu_item_labels,
    ingredients,
    menu_item_ingredients,
    orders,
    order_items,
    carts,
    cart_items,
    payments,
    payment_events,
    favorites,
    recommendations
    CASCADE;

CREATE TABLE IF NOT EXISTS users (
                                     user_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                     first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    email VARCHAR(150) UNIQUE NOT NULL,
    password TEXT NOT NULL,
    role VARCHAR(20) NOT NULL DEFAULT 'student',
    refresh_token TEXT,
    refresh_token_expires_at TIMESTAMP
    );

CREATE TABLE IF NOT EXISTS students (
                                        student_id INT PRIMARY KEY,
                                        loyalty_points INT DEFAULT 0 NOT NULL,
                                        reserved_points INT DEFAULT 0 NOT NULL
);

CREATE TABLE IF NOT EXISTS menu_items (
                                          menu_item_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                          name VARCHAR(150) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL,
    calories INT,
    is_available BOOLEAN DEFAULT true,
    current_stock INT,
    picture_link VARCHAR(255)
    );

CREATE TABLE IF NOT EXISTS menu_labels (
                                           label_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                           name VARCHAR(50) UNIQUE NOT NULL
    );

CREATE TABLE IF NOT EXISTS menu_item_labels (
                                                menu_item_id INT,
                                                label_id INT
);

CREATE TABLE IF NOT EXISTS ingredients (
                                           ingredient_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                           name VARCHAR(100) NOT NULL,
    allergens TEXT,
    calories_per_unit INT
    );

CREATE TABLE IF NOT EXISTS menu_item_ingredients (
                                                     menu_item_id INT,
                                                     ingredient_id INT,
                                                     quantity DECIMAL(10,2)
    );

CREATE TABLE IF NOT EXISTS orders (
                                      order_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                      student_id INT,
                                      status VARCHAR(20) DEFAULT 'pending',
    total_amount DECIMAL(10,2),
    created_at TIMESTAMP DEFAULT now(),
    updated_at TIMESTAMP DEFAULT now(),
    loyalty_points_used INT NOT NULL DEFAULT 0,
    total_loyalty_points_earned INT NOT NULL DEFAULT 0,
    final_amount_paid DECIMAL(10,2) NOT NULL DEFAULT 0,
    notes TEXT
    );

CREATE TABLE IF NOT EXISTS order_items (
                                           order_item_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                           order_id INT,
                                           menu_item_id INT,
                                           quantity INT NOT NULL,
                                           price DECIMAL(10,2) NOT NULL
    );

CREATE TABLE IF NOT EXISTS carts (
                                     cart_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                     student_id INT,
                                     status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT now(),
    updated_at TIMESTAMP DEFAULT now()
    );

CREATE TABLE IF NOT EXISTS cart_items (
                                          cart_item_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                          cart_id INT,
                                          menu_item_id INT,
                                          quantity INT NOT NULL,
                                          added_at TIMESTAMP DEFAULT now()
    );

CREATE TABLE IF NOT EXISTS payments (
                                        payment_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                        order_id INT UNIQUE,
                                        amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(10) DEFAULT 'RON',
    payment_method VARCHAR(20),
    payment_provider VARCHAR(50) DEFAULT 'mock',
    provider_payment_id VARCHAR(255),
    payment_intent_secret VARCHAR(255),
    status VARCHAR(20) DEFAULT 'pending',
    transaction_id VARCHAR(255),
    confirmed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT now(),
    updated_at TIMESTAMP DEFAULT now()
    );

CREATE TABLE IF NOT EXISTS payment_events (
                                              event_id INT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
                                              payment_id INT,
                                              event_type VARCHAR(50),
    event_status VARCHAR(20),
    message TEXT,
    payload JSON,
    created_at TIMESTAMP DEFAULT now()
    );

CREATE TABLE IF NOT EXISTS favorites (
                                         student_id INT,
                                         menu_item_id INT
);

CREATE TABLE IF NOT EXISTS recommendations (
                                               base_item_id INT,
                                               recommended_item_id INT,
                                               score DECIMAL(5,2)
    );

DO $$
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'students_student_id_fkey'
    ) THEN
ALTER TABLE students ADD CONSTRAINT students_student_id_fkey FOREIGN KEY (student_id) REFERENCES users (user_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'menu_item_labels_menu_item_id_fkey'
    ) THEN
ALTER TABLE menu_item_labels ADD CONSTRAINT menu_item_labels_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES menu_items (menu_item_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'menu_item_labels_label_id_fkey'
    ) THEN
ALTER TABLE menu_item_labels ADD CONSTRAINT menu_item_labels_label_id_fkey FOREIGN KEY (label_id) REFERENCES menu_labels (label_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'menu_item_ingredients_menu_item_id_fkey'
    ) THEN
ALTER TABLE menu_item_ingredients ADD CONSTRAINT menu_item_ingredients_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES menu_items (menu_item_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'menu_item_ingredients_ingredient_id_fkey'
    ) THEN
ALTER TABLE menu_item_ingredients ADD CONSTRAINT menu_item_ingredients_ingredient_id_fkey FOREIGN KEY (ingredient_id) REFERENCES ingredients (ingredient_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'orders_student_id_fkey'
    ) THEN
ALTER TABLE orders ADD CONSTRAINT orders_student_id_fkey FOREIGN KEY (student_id) REFERENCES students (student_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'order_items_order_id_fkey'
    ) THEN
ALTER TABLE order_items ADD CONSTRAINT order_items_order_id_fkey FOREIGN KEY (order_id) REFERENCES orders (order_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'order_items_menu_item_id_fkey'
    ) THEN
ALTER TABLE order_items ADD CONSTRAINT order_items_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES menu_items (menu_item_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'carts_student_id_fkey'
    ) THEN
ALTER TABLE carts ADD CONSTRAINT carts_student_id_fkey FOREIGN KEY (student_id) REFERENCES students (student_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'cart_items_cart_id_fkey'
    ) THEN
ALTER TABLE cart_items ADD CONSTRAINT cart_items_cart_id_fkey FOREIGN KEY (cart_id) REFERENCES carts (cart_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'cart_items_menu_item_id_fkey'
    ) THEN
ALTER TABLE cart_items ADD CONSTRAINT cart_items_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES menu_items (menu_item_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'payments_order_id_fkey'
    ) THEN
ALTER TABLE payments ADD CONSTRAINT payments_order_id_fkey FOREIGN KEY (order_id) REFERENCES orders (order_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'payment_events_payment_id_fkey'
    ) THEN
ALTER TABLE payment_events ADD CONSTRAINT payment_events_payment_id_fkey FOREIGN KEY (payment_id) REFERENCES payments (payment_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'favorites_student_id_fkey'
    ) THEN
ALTER TABLE favorites ADD CONSTRAINT favorites_student_id_fkey FOREIGN KEY (student_id) REFERENCES students (student_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'favorites_menu_item_id_fkey'
    ) THEN
ALTER TABLE favorites ADD CONSTRAINT favorites_menu_item_id_fkey FOREIGN KEY (menu_item_id) REFERENCES menu_items (menu_item_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'recommendations_base_item_id_fkey'
    ) THEN
ALTER TABLE recommendations ADD CONSTRAINT recommendations_base_item_id_fkey FOREIGN KEY (base_item_id) REFERENCES menu_items (menu_item_id);
END IF;

    IF NOT EXISTS (
        SELECT 1 FROM information_schema.table_constraints
        WHERE constraint_name = 'recommendations_recommended_item_id_fkey'
    ) THEN
ALTER TABLE recommendations ADD CONSTRAINT recommendations_recommended_item_id_fkey FOREIGN KEY (recommended_item_id) REFERENCES menu_items (menu_item_id);
END IF;
END
$$;


INSERT INTO users (first_name, last_name, email, password, role)
VALUES (
           'System',
           'Administrator',
           'admin@campuseats.com',
           '$2a$11$8z7ahfdSVwbsJAdDOZcR4.aJyRveVampDWMZp6RhJ5ppEx5w6ZDva',
           'admin'
       );

INSERT INTO ingredients (name, allergens, calories_per_unit)
VALUES
    ('Chicken Breast', NULL, 165),
    ('Tomato', NULL, 18),
    ('Mozzarella Cheese', 'Milk', 280),
    ('Spaghetti', 'Gluten', 350),
    ('Basil', NULL, 1),
    ('Beef Patty', NULL, 295),
    ('Lettuce', NULL, 5),
    ('Cheddar Cheese', 'Milk', 403),
    ('French Fries', NULL, 312),
    ('Olive Oil', NULL, 119);

INSERT INTO menu_items (name, description, price, calories, current_stock)
VALUES
    ('Chicken Salad', 'Fresh salad with grilled chicken', 25.00, 350, 40),
    ('Margherita Pizza', 'Classic pizza with tomato and mozzarella', 32.00, 800, 20),
    ('Spaghetti Bolognese', 'Pasta with beef ragu', 28.00, 700, 30),
    ('Cheeseburger', 'Beef burger with cheddar cheese', 22.00, 900, 50),
    ('French Fries', 'Crispy salted fries', 10.00, 440, 100),
    ('Caprese Salad', 'Tomato, mozzarella, olive oil & basil', 20.00, 400, 25);

-- Chicken Salad
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, quantity) VALUES
                                                                              (1, 1, 150),  -- Chicken Breast
                                                                              (1, 2, 50),   -- Tomato
                                                                              (1, 7, 20);   -- Lettuce

-- Margherita Pizza
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, quantity) VALUES
                                                                              (2, 2, 80),   -- Tomato
                                                                              (2, 3, 100),  -- Mozzarella
                                                                              (2, 5, 5);    -- Basil

-- Spaghetti Bolognese
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, quantity) VALUES
                                                                              (3, 4, 180),  -- Spaghetti
                                                                              (3, 1, 80);   -- Chicken (temporary substitute for beef if needed)

-- Cheeseburger
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, quantity) VALUES
                                                                              (4, 6, 150),  -- Beef Patty
                                                                              (4, 8, 40),   -- Cheddar
                                                                              (4, 7, 15);   -- Lettuce

-- French Fries
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, quantity) VALUES
    (5, 9, 150);  -- Fries

-- Caprese Salad
INSERT INTO menu_item_ingredients (menu_item_id, ingredient_id, quantity) VALUES
                                                                              (6, 2, 60),   -- Tomato
                                                                              (6, 3, 80),   -- Mozzarella
                                                                              (6, 10, 10),  -- Olive Oil
                                                                              (6, 5, 3);    -- Basil

INSERT INTO menu_labels (name) VALUES
                                   ('Healthy'),
                                   ('Fast Food'),
                                   ('Vegetarian'),
                                   ('Pasta'),
                                   ('Salad');

INSERT INTO menu_item_labels (menu_item_id, label_id) VALUES
                                                          (1, 1), -- Chicken Salad → Healthy
                                                          (1, 5), -- Chicken Salad → Salad
                                                          (2, 3), -- Margherita Pizza → Vegetarian
                                                          (3, 4), -- Spaghetti Bolognese → Pasta
                                                          (4, 2), -- Cheeseburger → Fast Food
                                                          (5, 2), -- Fries → Fast Food
                                                          (6, 3), -- Caprese → Vegetarian
                                                          (6, 5); -- Caprese → Salad

/* =========================
   USERS & STUDENTS
   ========================= */
    
/*pasword: testtest*/
INSERT INTO users (first_name, last_name, email, password, role) VALUES
                                                                     ('Alice', 'Popescu', 'alice.popescu@student.com', '$2a$11$C/sqqz5Bq9H23uK0sAhvYOrzausbjI5mKZ3XToeKXLc9aaLUyfEry', 'student'),
                                                                     ('Bob', 'Ionescu', 'bob.ionescu@student.com', '$2a$11$C/sqqz5Bq9H23uK0sAhvYOrzausbjI5mKZ3XToeKXLc9aaLUyfEry', 'student'),
                                                                     ('Carla', 'Dumitru', 'carla.dumitru@student.com', '$2a$11$C/sqqz5Bq9H23uK0sAhvYOrzausbjI5mKZ3XToeKXLc9aaLUyfEry', 'student'),
                                                                     ('Dan', 'Marin', 'dan.marin@student.com', '$2a$11$C/sqqz5Bq9H23uK0sAhvYOrzausbjI5mKZ3XToeKXLc9aaLUyfEry', 'student'),
                                                                     ('Elena', 'Radu', 'elena.radu@student.com', '$2a$11$C/sqqz5Bq9H23uK0sAhvYOrzausbjI5mKZ3XToeKXLc9aaLUyfEry', 'student');

INSERT INTO students (student_id, loyalty_points, reserved_points) VALUES
                                                                       (2, 120, 20),
                                                                       (3, 80, 0),
                                                                       (4, 200, 50),
                                                                       (5, 45, 0),
                                                                       (6, 300, 100);

/* =========================
   CARTS & CART ITEMS
   ========================= */

INSERT INTO carts (student_id, status) VALUES
                                           (2, 'active'),
                                           (3, 'active'),
                                           (4, 'checked_out'),
                                           (5, 'active'),
                                           (6, 'checked_out');

INSERT INTO cart_items (cart_id, menu_item_id, quantity) VALUES
                                                             (1, 1, 1),
                                                             (1, 5, 2),
                                                             (2, 2, 1),
                                                             (3, 4, 1),
                                                             (3, 5, 1),
                                                             (4, 6, 1),
                                                             (5, 3, 2);

/* =========================
   ORDERS & ORDER ITEMS
   ========================= */

INSERT INTO orders
(student_id, status, total_amount, loyalty_points_used, total_loyalty_points_earned, final_amount_paid)
VALUES
    (4, 'completed', 32.00, 0, 16, 32.00),
    (6, 'completed', 54.00, 20, 27, 34.00),
    (2, 'completed', 35.00, 10, 17, 25.00),
    (3, 'pending', 22.00, 0, 0, 22.00);

INSERT INTO order_items (order_id, menu_item_id, quantity, price) VALUES
                                                                      (1, 2, 1, 32.00),
                                                                      (2, 3, 1, 28.00),
                                                                      (2, 5, 1, 10.00),
                                                                      (3, 1, 1, 25.00),
                                                                      (3, 5, 1, 10.00),
                                                                      (4, 4, 1, 22.00);

/* =========================
   PAYMENTS & PAYMENT EVENTS
   ========================= */

INSERT INTO payments
(order_id, amount, payment_method, status, transaction_id, confirmed_at)
VALUES
    (1, 32.00, 'card', 'succeeded', 'TXN1001', now()),
    (2, 34.00, 'card', 'succeeded', 'TXN1002', now()),
    (3, 25.00, 'wallet', 'succeeded', 'TXN1003', now()),
    (4, 22.00, 'card', 'pending', 'TXN1004', NULL);

INSERT INTO payment_events
(payment_id, event_type, event_status, message)
VALUES
    (1, 'payment_intent', 'success', 'Payment completed successfully'),
    (2, 'payment_intent', 'success', 'Loyalty points applied'),
    (3, 'payment_intent', 'success', 'Wallet payment confirmed'),
    (4, 'payment_intent', 'pending', 'Awaiting confirmation');

/* =========================
   FAVORITES
   ========================= */

INSERT INTO favorites (student_id, menu_item_id) VALUES
                                                     (2, 1),
                                                     (2, 5),
                                                     (3, 2),
                                                     (4, 4),
                                                     (5, 6),
                                                     (6, 3);

/* =========================
   RECOMMENDATIONS
   ========================= */

INSERT INTO recommendations (base_item_id, recommended_item_id, score) VALUES
                                                                           (1, 6, 0.92),
                                                                           (2, 5, 0.88),
                                                                           (3, 1, 0.75),
                                                                           (4, 5, 0.90),
                                                                           (6, 1, 0.85);

select * from users; 