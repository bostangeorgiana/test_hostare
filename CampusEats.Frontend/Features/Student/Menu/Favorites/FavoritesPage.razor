@page "/favorites"
@using CampusEats.Frontend.Features.Menu.Models
@using CampusEats.Frontend.Models
@using CampusEats.Frontend.Features.Student.Menu.Favorites
@using CampusEats.Frontend.Services
@using CampusEats.Frontend.Services.Auth
@using CampusEats.Frontend.Features.Student.Cart.Services

@inject CampusEats.Frontend.Features.Student.Cart.Services.CartService Cart
@inject FavoritesService FavoritesService
@inject AuthStateService Auth
@inject NavigationManager Nav

<div class="max-w-7xl mx-auto p-8 bg-gray-50 min-h-screen">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">❤️ My Favorites</h1>
        <p class="text-gray-600">Your saved meals, ready to order</p>
    </div>

    @if (favorites == null)
    {
        <div class="flex flex-col items-center justify-center py-20">
            <div class="w-12 h-12 border-4 border-emerald-600 border-t-transparent rounded-full animate-spin"></div>
            <p class="mt-4 text-gray-600 font-medium">Loading favorites...</p>
        </div>
    }
    else if (favorites.Count == 0)
    {
        <div class="bg-white rounded-2xl p-16 text-center border border-gray-200">
            <span class="text-6xl mb-4 block">⭐</span>
            <h3 class="text-2xl font-semibold text-gray-900 mb-2">No favorites yet</h3>
            <p class="text-gray-600 mb-6">Start exploring the menu and save items you love!</p>

            <button class="px-8 py-3 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-xl transition-colors"
                    @onclick="BrowseMenu">
                Browse Menu
            </button>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            @foreach (var item in favorites)
            {
                <div class="bg-white rounded-2xl border border-gray-200 overflow-hidden hover:shadow-lg hover:border-gray-300 transition-all @(!item.IsAvailable || item.CurrentStock <= 0 ? "opacity-60" : "")">
                    
                    <div class="aspect-video bg-gray-100 overflow-hidden">
                        <img src='@(string.IsNullOrWhiteSpace(item.PictureLink) ? "/images/default-menu-item.svg" : item.PictureLink)' 
                             alt="@item.Name" 
                             class="w-full h-full object-cover"
                             onerror="this.onerror=null;this.src='/images/default-menu-item.svg'" />
                    </div>

                    <div class="p-6">
                        <div class="flex justify-between items-start mb-3">
                            <h3 class="text-lg font-bold text-gray-900 flex-1">@item.Name</h3>
                            <span class="text-xl font-bold text-emerald-600 ml-2">@item.Price.ToString("0.00") RON</span>
                        </div>

                        <p class="text-sm text-gray-600 mb-4 line-clamp-2">@item.Description</p>

                        @if (item.IsAvailable && item.CurrentStock > 0)
                        {
                            <div class="flex items-center justify-between mb-4">
                                <span class="text-sm font-medium text-emerald-600">@item.CurrentStock available</span>
                            </div>

                            <button class="w-full px-5 py-3 text-white font-semibold rounded-xl transition-colors @( _addingItemIds.Contains(item.MenuItemId) ? "bg-[#059669]" : "bg-emerald-600 hover:bg-emerald-700")"
                                    disabled="@(_addingItemIds.Contains(item.MenuItemId))"
                                    @onclick="() => AddToOrder(item)">
                                Add to Order
                            </button>

                            @if (_addToCartErrors.TryGetValue(item.MenuItemId, out var addErr))
                            {
                                <p class="text-red-600 text-sm mt-2">@addErr</p>
                            }
                        }
                        else
                        {
                            <div class="flex items-center justify-center py-3 bg-red-50 text-red-600 rounded-xl font-semibold text-sm">
                                Not available today
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<MenuItemDto>? favorites;

    // per-item add-to-cart state/errors
    private readonly HashSet<int> _addingItemIds = new();
    private readonly Dictionary<int, string> _addToCartErrors = new();

    protected override async Task OnInitializedAsync()
    {
        favorites = await FavoritesService.GetFavoritesAsync(Auth.UserId);
    }

    private void BrowseMenu()
    {
        Nav.NavigateTo("/student/menu");
    }

    private async Task AddToOrder(MenuItemDto item)
    {
        // clear previous per-item error
        _addToCartErrors.Remove(item.MenuItemId);

        // mark as adding
        _addingItemIds.Add(item.MenuItemId);
        StateHasChanged();

        var (success, error) = await Cart.TryAddItemAsync(item);

        // remove adding state
        _addingItemIds.Remove(item.MenuItemId);

        if (!success)
        {
            _addToCartErrors[item.MenuItemId] = MapAddToCartError(error);
            StateHasChanged();
            return;
        }

        // success
        _addToCartErrors.Remove(item.MenuItemId);
        StateHasChanged();
    }

    private static string MapAddToCartError(string? error)
    {
        if (string.IsNullOrWhiteSpace(error))
            return "You cannot add this item to the order.";

        if (error.Contains("Out of stock", StringComparison.OrdinalIgnoreCase) ||
            error.Contains("stoc", StringComparison.OrdinalIgnoreCase) ||
            error.Contains("Out of stock", StringComparison.OrdinalIgnoreCase))
        {
            return "You have already reached the maximum quantity available for this product.";
        }

        return error;
    }
}
