@page "/orders/{OrderId:int}"

@using CampusEats.Frontend.Models
@using CampusEats.Frontend.Services
@using CampusEats.Frontend.Services.Auth
@using CampusEats.Frontend.Features.Payment.Components
@using CampusEats.Frontend.Features.Student.Order.Models

@inject OrderApi Api
@inject NavigationManager Nav
@inject AuthStateService Auth

<div class="max-w-7xl mx-auto p-8 bg-teal-50 min-h-screen">
    @if (_details == null)
    {
        <div class="flex flex-col items-center justify-center py-20">
            <div class="spinner"></div>
            <p>Loading order details...</p>
        </div>
    }
    else
    {
        <div class="text-teal-600 font-medium mb-6 cursor-pointer hover:text-teal-700" @onclick="@(() => Nav.NavigateTo("/orders"))">
            ← Back to Orders
        </div>

        <div class="flex justify-between items-start mb-8">
            <div>
                <h1 class="text-4xl font-bold text-teal-900 mb-2">Order #@_details.OrderId</h1>
                <p class="text-gray-600">
                    Placed on @_details.CreatedAt.ToString("MMMM dd, yyyy · HH:mm")
                </p>
            </div>
            <span class="px-4 py-2 rounded-lg font-bold text-sm uppercase @GetStatusClass(_details.Status)">
                @_details.Status.ToUpper()
            </span>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Items Card -->
            <div class="lg:col-span-2 bg-white rounded-xl p-6 shadow-sm">
                <h2 class="text-2xl font-bold text-teal-900 mb-6">Order Items</h2>
                <div class="space-y-4">
                    @foreach (var item in _details.Items)
                    {
                        <div class="flex justify-between items-center py-4 border-b border-gray-100 last:border-b-0">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-800">@item.MenuItemName</h3>
                                <p class="text-sm text-gray-500 mt-1">@item.Price RON × @item.Quantity</p>
                            </div>
                            <span class="text-xl font-bold text-teal-600">@(item.Price * item.Quantity) RON</span>
                        </div>
                    }
                </div>

                @if (_details.Status == "paid")
                {
                    <div class="flex justify-between items-center py-3 border-t border-gray-200 mt-6">
                        <span class="text-gray-600 font-medium">Original Total</span>
                        <span class="text-lg font-semibold text-gray-800">@_details.TotalAmount RON</span>
                    </div>

                    <div class="flex justify-between items-center py-3">
                        <span class="text-gray-600 font-medium">Points Used</span>
                        <span class="text-lg font-semibold text-gray-800">@_details.LoyaltyPointsUsed</span>
                    </div>

                    <div class="flex justify-between items-center py-3">
                        <span class="text-gray-600 font-medium">Points Earned</span>
                        <span class="text-lg font-semibold text-teal-600">@_details.TotalLoyaltyPointsEarned</span>
                    </div>
                }

                <div class="flex justify-between items-center py-4 border-t-2 border-teal-500 mt-4">
                    <span class="text-lg font-bold text-gray-800">Total Paid</span>
                    <span class="text-2xl font-bold text-teal-600">@_details.FinalAmountPaid RON</span>
                </div>

            </div>

            <!-- Summary Card -->
            <div class="bg-white rounded-xl p-6 shadow-sm h-fit">
                <h2 class="text-2xl font-bold text-teal-900 mb-6">Order Summary</h2>

                <div class="space-y-4">
                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600 font-medium">Order ID</span>
                        <span class="font-semibold text-gray-800">#@_details.OrderId</span>
                    </div>

                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600 font-medium">Status</span>
                        <span class="px-3 py-1 rounded-lg font-bold text-xs uppercase @GetStatusClass(_details.Status)">
                            @_details.Status.ToUpper()
                        </span>
                    </div>

                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600 font-medium">Items</span>
                        <span class="font-semibold text-gray-800">@_details.Items.Sum(i => i.Quantity)</span>
                    </div>

                    <div class="flex justify-between items-center py-2">
                        <span class="text-gray-600 font-medium">Order Date</span>
                        <span class="font-semibold text-gray-800">@_details.CreatedAt.ToString("MMM dd, yyyy")</span>
                    </div>
                    
                </div>

                @if (_details.Status == "pending")
                {
                    <OrderPaymentSection
                        OrderId="@_details.OrderId"
                        Amount="@_details.TotalAmount"
                        AvailablePoints="@AvailablePoints"
                        PointsToUse="@PointsToUse"
                        OnPaymentCompleted="HandlePaymentCompleted"
                        OnOrderCancelled="HandleOrderCancelled" />

                }

            </div>
        </div>
    }
</div>

@code {
    [Parameter] public int OrderId { get; set; }

    private bool isLoading = true;
    private int PointsToUse = 0;
    private decimal Amount = 0;
    
    private int AvailablePoints = 0;
    private OrderDetailsDto? _details;

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        _details = await Api.GetDetails(OrderId);
        Amount = _details.TotalAmount;

        var loyalty = await Api.GetLoyalty(Auth.UserId);
      
        AvailablePoints = loyalty?.LoyaltyPoints ?? 0;

        isLoading = false;
    }


    private async Task HandlePaymentCompleted()
    {
        // Don't set the status locally here; re-fetch server-side details which contain the canonical status and payment fields
    
        var updatedDetails = await Api.GetDetails(OrderId);
        if (updatedDetails != null)
        {
            _details = updatedDetails;
        }
        
        var loyalty = await Api.GetLoyalty(Auth.UserId);
        AvailablePoints = loyalty?.LoyaltyPoints ?? 0; 

        StateHasChanged();
    }



    private async Task HandleOrderCancelled()
    {
        await Api.CancelOrder(OrderId, Auth.UserId);
        _details!.Status = "cancelled";
        StateHasChanged();
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "paid" => "bg-teal-100 text-teal-800",
            "pending" => "bg-yellow-100 text-yellow-800",
            "cancelled" => "bg-red-100 text-red-800",
            _ => "bg-gray-100 text-gray-800"
        };
    }

}